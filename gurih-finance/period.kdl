enum "PeriodStatus" {
    Draft
    Open
    Closed
    Locked
}

entity "AccountingPeriod" {
    field:pk id
    field:string "name" // e.g. "Jan 2024"
    field:date "start_date"
    field:date "end_date"
    field:enum "status" "PeriodStatus" default="Draft"
    options {
        track_changes #true
    }
}

workflow "PeriodWorkflow" for="AccountingPeriod" field="status" {
    state "Draft" initial=#true
    state "Open"
    state "Closed"
    state "Locked"

    transition "activate" {
        from "Draft"
        to "Open"
        requires {
            no_period_overlap #true
        }
    }

    transition "close" {
        from "Open"
        to "Closed"
    }

    transition "lock" {
        from "Closed"
        to "Locked"
    }

    transition "reopen" {
        from "Closed"
        to "Open"
        requires {
            no_period_overlap #true
        }
    }
}

page "PeriodList" {
    title "Accounting Periods"
    datatable for="AccountingPeriod" {
        column "name"
        column "start_date"
        column "end_date"
        column "status"

        action "Activate" method="POST" to="/api/workflow/activate" variant="primary"
        action "Close" method="POST" to="/api/workflow/close"
        action "Lock" method="POST" to="/api/workflow/lock"
    }
}

page "PeriodForm" {
    title "Period"
    form for="AccountingPeriod" {
        field "name"
        group {
            field "start_date"
            field "end_date"
        }
        field "status"
    }
}

action "GenerateClosingEntry" {
    params "id"
    step "finance:generate_closing_entry" period_id="param('id')"
}

routes {
    group "/finance/periods" {
        route:post "/:id/close" action="GenerateClosingEntry"
    }
}
