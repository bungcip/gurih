// Reporting queries

query:hierarchy "TrialBalanceQuery" for="Account" {
    params "start_date" "end_date"
    select "code"
    select "name"
    select "parent"

    hierarchy parent="parent" {
        rollup "opening_balance"
        rollup "period_debit"
        rollup "period_credit"
        rollup "closing_balance"
    }

    // Opening Balance (Before Start Date)
    formula "opening_balance" "SUM(if([journal_entry.date] < param('start_date'), [debit] - [credit], 0))"

    // Period Movement
    formula "period_debit" "SUM(if([journal_entry.date] >= param('start_date') && [journal_entry.date] <= param('end_date'), [debit], 0))"
    formula "period_credit" "SUM(if([journal_entry.date] >= param('start_date') && [journal_entry.date] <= param('end_date'), [credit], 0))"

    // Closing Balance (End Date)
    formula "closing_balance" "SUM(if([journal_entry.date] <= param('end_date'), [debit] - [credit], 0))"

    join "JournalLine" {
        select "debit"
        select "credit"

        join "JournalEntry" {
            // Filter only
        }
    }

    filter "[journal_entry.status] == 'Posted'"

    group_by "id"
    group_by "code"
    group_by "name"
    group_by "parent"
}

page "TrialBalanceReport" {
    title "Trial Balance"
    datatable query="TrialBalanceQuery" {
        column "code"
        column "name"
        column "opening_balance"
        column "period_debit"
        column "period_credit"
        column "closing_balance"
    }
}

page "BalanceSheetReport" {
    title "Balance Sheet"
    datatable query="TrialBalanceQuery" { // reusing for simplicity
        column "code"
        column "name"
    }
}

// General Ledger

query:flat "LedgerQuery" for="JournalLine" {
    params "account_id"
    select "journal_entry.date" as "date"
    select "journal_entry.description" as "description"
    select "debit"
    select "credit"

    // Running Balance: SUM(debit - credit) OVER (PARTITION BY account ORDER BY date)
    formula "balance" "running_sum([debit] - [credit], [account], [journal_entry.date])"

    join "JournalEntry" {
        // Filter only
    }

    filter "[account] == param('account_id')"
    filter "[journal_entry.status] == 'Posted'"

    // No group_by, detailed list
}

page "LedgerReport" {
    title "General Ledger"
    datatable query="LedgerQuery" {
        column "date"
        column "description"
        column "debit"
        column "credit"
        column "balance"
    }
}

page "IncomeStatementReport" {
    title "Income Statement"
    datatable query="TrialBalanceQuery" {
        column "code"
        column "name"
    }
}
