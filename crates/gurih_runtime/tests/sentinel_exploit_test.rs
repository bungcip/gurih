use bytes::Bytes;
use gurih_runtime::storage::{FileDriver, LocalFileDriver};
use std::fs;

#[tokio::test]
async fn test_upload_htaccess_vulnerability() {
    let temp_dir = std::env::temp_dir().join("gurih_sentinel_test");
    let base_path = temp_dir.join("safe_zone");
    let _ = fs::remove_dir_all(&temp_dir);

    let driver = LocalFileDriver::new(base_path.to_str().unwrap());

    // Exploit attempt: Uploading .htaccess
    let filename = ".htaccess";
    let payload = Bytes::from("AddType application/x-httpd-php .png"); // Example malicious config

    // This should now FAIL
    let result = driver.put(filename, payload).await;

    // Verify the fix
    assert!(result.is_err(), "Hidden file upload should be rejected");
    let err = result.err().unwrap();
    assert!(
        err.contains("Hidden files or empty filenames are not allowed"),
        "Unexpected error message: {}",
        err
    );

    // Clean up
    let _ = fs::remove_dir_all(&temp_dir);
}

#[tokio::test]
async fn test_upload_trailing_dot_exploit() {
    let temp_dir = std::env::temp_dir().join("gurih_sentinel_test_dot");
    let base_path = temp_dir.join("safe_zone");
    let _ = fs::remove_dir_all(&temp_dir);

    let driver = LocalFileDriver::new(base_path.to_str().unwrap());

    // Exploit attempt: Trailing dot
    let filename = "exploit.php.";
    let payload = Bytes::from("<?php system($_GET['cmd']); ?>");

    // This should now FAIL
    let result = driver.put(filename, payload).await;

    // Verify the fix
    assert!(result.is_err(), "Trailing dot upload should be rejected");
    let err = result.err().unwrap();
    assert!(
        err.contains("Filenames cannot end with a dot"),
        "Unexpected error message: {}",
        err
    );

    // Clean up
    let _ = fs::remove_dir_all(&temp_dir);
}
