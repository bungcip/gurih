name "GurihHR"
version "0.1.0"

database {
    type "sqlite"
    url "file:hr.db"
}

// -----------------------------------------------------------------------------
// ICONS
// -----------------------------------------------------------------------------
icons {
    "dashboard" "lucide:layout-dashboard"
    "users" "lucide:users"
    "user" "lucide:user"
    "calendar" "lucide:calendar"
    "settings" "lucide:settings"
    "check" "lucide:check-circle"
    "x" "lucide:x-circle"
    "clock" "lucide:clock"
    "plus" "lucide:plus"
    "pencil" "lucide:pencil"
    "trash" "lucide:trash-2"
}

// -----------------------------------------------------------------------------
// LAYOUTS
// -----------------------------------------------------------------------------
layout "MainLayout" {
    header {
        search_bar "true"
        user_menu "true"
    }
    sidebar {
        menu_ref "MainMenu"
        collapsible "true"
    }
    footer "GurihHR Â© 2026"
}

// -----------------------------------------------------------------------------
// ENUMS & GENERATORS
// -----------------------------------------------------------------------------
enum "EmploymentStatus" {
    Probation
    Permanent
    Contract
    Resigned
    Terminated
}

enum "LeaveStatus" {
    Draft
    Pending
    Approved
    Rejected
    Cancelled
}

serial_generator "EmpCode" {
    prefix "EMP/"
    date "YYYY"
    sequence digits=4
}

include "organization.kdl"
include "personnel.kdl"
include "user.kdl"

// -----------------------------------------------------------------------------
// MODULE: LEAVE MANAGEMENT (With Workflow)
// -----------------------------------------------------------------------------
module "Leave" {
    entity "LeaveRequest" {
        field:pk id
        belongs_to "Employee"
        field:date "start_date"
        field:date "end_date"
        field:text "reason"
        field:enum "status" "LeaveStatus" default="Draft"
        
        options {
            is_submittable #true
            track_changes #true
        }
    }

    workflow "LeaveWorkflow" for="LeaveRequest" field="status" {
        state "Draft" initial="true"
        state "Pending"
        state "Approved"
        state "Rejected"
        state "Cancelled"

        transition "submit" {
            from "Draft"
            to "Pending"
        }
        
        transition "approve" {
            from "Pending"
            to "Approved"
        }

        transition "reject" {
            from "Pending" 
            to "Rejected"
        }
        
        transition "cancel" {
            from "Draft" "Pending"
            to "Cancelled"
        }
    }
}


// -----------------------------------------------------------------------------
// QUERIES
// -----------------------------------------------------------------------------
query:flat "EmployeeQuery" for="Employee" {
    select "id"
    select "full_name"
    select "status"
    
    join "Department" {
        select "name" as="department_name"
    }
}

query:flat "LeaveRequestQuery" for="LeaveRequest" {
    select "id"
    select "start_date"
    select "end_date"
    select "status"
    
    join "Employee" {
        select "full_name" as="employee_name"
    }
}

// -----------------------------------------------------------------------------
// UI: PAGES & DASHBOARD
// -----------------------------------------------------------------------------
dashboard "HRDashboard" {
    title "HR Overview"
    
    grid columns=3 {
        widget "TotalEmployees" type="stat" {
            label "Total Employees"
            value "count:Employee[status=Permanent]"
            icon "users"
        }
        widget "PendingLeaves" type="stat" {
            label "Pending Leave Requests"
            value "count:LeaveRequest[status=Pending]"
            icon "clock"
            color "warning"
        }
        widget "EmployeeStatus" type="pie" {
            label "Employee Status"
            value "group:Employee[status]"
        }
    }
}

page "EmployeeList" {
    title "Employees"
    datatable for="Employee" query="EmployeeQuery" {
        column "id" label="ID"
        column "full_name" label="Name"
        column "department_name" label="Department"
        column "status" label="Status"
        
        action "Edit" icon="pencil" to="/employees/:id"
        action "Delete" icon="trash" variant="danger" to="/employees/:id" method="DELETE"
    }
}

page "EmployeeForm" {
    title "Employee Details"
    form for="Employee" {
        section "Basic Info" {
            field "full_name"
            field "email_address"
            field "phone_number"
        }
        section "Job Details" {
            group {
                field "department"
                field "position"
            }
            group {
                field "join_date"
                field "status"
            }
        }
    }
}

page "LeaveList" {
    title "Leave Requests"
    datatable for="LeaveRequest" query="LeaveRequestQuery" {
        column "employee_name" label="Employee"
        column "start_date"
        column "end_date"
        column "status"
        
        action "Review" icon="check" to="/leave/:id"
    }
}

// -----------------------------------------------------------------------------
// UI: ORGANIZATION PAGES
// -----------------------------------------------------------------------------
page "DepartmentList" {
    title "Departments"
    datatable for="Department" {
        column "name"
        column "description"
        
        action "Edit" icon="pencil" to="/departments/:id"
        action "Delete" icon="trash" variant="danger" to="/departments/:id" method="DELETE"
    }
}

page "DepartmentForm" {
    title "Department"
    form for="Department" {
        section "General" {
            field "name"
            field "description"
        }
    }
}

page "PositionList" {
    title "Positions"
    datatable for="Position" {
        column "title"
        column "description"
        column "base_salary"
        
        action "Edit" icon="pencil" to="/positions/:id"
        action "Delete" icon="trash" variant="danger" to="/positions/:id" method="DELETE"
    }
}

page "PositionForm" {
    title "Position"
    form for="Position" {
        section "General" {
            field "title"
            field "description"
            field "base_salary"
        }
    }
}

// -----------------------------------------------------------------------------
// ROUTING & MENU
// -----------------------------------------------------------------------------
routes {
    route "/" to="HRDashboard" layout="MainLayout"
    
    group "/employees" layout="MainLayout" permission="hr.employee.view" {
        route "/" to="EmployeeList"
        route "/new" to="EmployeeForm" permission="hr.employee.create"
        route "/:id" to="EmployeeForm" permission="hr.employee.edit"
        route:delete "/:id" action="DeleteEmployee"
    }
    
    group "/departments" layout="MainLayout" {
        route "/" to="DepartmentList"
        route "/new" to="DepartmentForm"
        route "/:id" to="DepartmentForm"
        route:delete "/:id" action="DeleteDepartment"
    }
    
    group "/positions" layout="MainLayout" {
        route "/" to="PositionList"
        route "/new" to="PositionForm"
        route "/:id" to="PositionForm"
        route:delete "/:id" action="DeletePosition"
    }

    group "/leave" layout="MainLayout" {
        route "/" to="LeaveList"
        // ... detailed routes
    }
}

menu "MainMenu" {
    item "Dashboard" to="/" icon="dashboard"
    
    group "Personnel" icon="users" {
        item "Employees" to="/employees"
    }
    
    group "Organization" icon="building" {
        item "Departments" to="/departments"
        item "Positions" to="/positions"
    }
    
    group "Leave Management" icon="calendar" {
        item "Requests" to="/leave"
    }
}

// -----------------------------------------------------------------------------
// ACL
// -----------------------------------------------------------------------------
role "HRManager" {
    allow "*"
}

role "Employee" {
    allow "/" "read"
    allow "/leave/*" "read,write" // Can only see/edit own leaves (logic handled in app layer usually)
}
